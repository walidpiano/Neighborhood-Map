<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Neighborbood Map</title>

    <!-- jquery library-->
    <script src="libs/jquery-3.3.1.min.js"></script>
    
   <!-- bootstrap libraries -->
    <link rel="stylesheet" href="libs/bootstrap/bootstrap.min.css">
    <script src="libs/bootstrap/popper.min.js"></script>
    <script src="libs/bootstrap/bootstrap.min.js"></script>


    <!-- My Custom CSS -->
    <link rel="stylesheet" href="css/style.css">



    <!-- knockout link -->
    <script src="libs/knockout-3.2.0.js"></script>

    <!-- link to js codes -->
    <!--<script src="js/app.js"></script>-->

    <!--
        Hamburger menu inspired from the below website:
    https://bootstrapious.com/p/bootstrap-sidebar
    -->
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar  -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3>Menu</h3>
            </div>
            <form data-bind="submit: addFilter">
                <input id="location-filter" data-bind="value: searchQuery" class="form-control" type="text" placeholder="Search location..." autocomplete="off"/>
            </form>
            
            <ul class="list-unstyled components" data-bind="foreach: locationList">
                <li data-bind="text: title, click: bounceMarker"></li>
            </ul>

        </nav>

        <!-- Page Content  -->
        <div id="content">

            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-info"></button>
                    <h1>Neighborbood Map</h1>
                </div>
            </nav>

            <div id="map"></div>
        </div>
    </div>
    
    <script>

        // for pressing hamburger button
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar').toggleClass('active');
        });

        var locations = [
            { title: 'Park Ave Penthouse', location: { lat: 40.7713024, lng: -73.9632393}},
            { title: 'Chelsea Loft', location: { lat: 40.7444883, lng: -73.9949465}},
            { title: 'Union Square Open Floor Plan', location: { lat: 40.7347062, lng: -73.9895759}},
            { title: 'East Village Hip Studio', location: { lat: 40.7281777, lng: -73.984377}},
            { title: 'TriBeCa Artsy Bachelor Pad', location: { lat: 40.7195264, lng: -74.0089934}},
            { title: 'Chinatown Homey Space', location: { lat: 40.7180628, lng: -73.9961237}}
        ];


        var map;
        var markers = [];
        var largeInfowindow;
        var bounds;
        var highlightedIcon;
        var defaultIcon;

        // Create a styles array to use with the map.
        var styles = [
          {
            featureType: 'water',
            stylers: [
              { color: '#19a0d8' }
            ]
          },{
            featureType: 'administrative',
            elementType: 'labels.text.stroke',
            stylers: [
              { color: '#ffffff' },
              { weight: 6 }
            ]
          },{
            featureType: 'administrative',
            elementType: 'labels.text.fill',
            stylers: [
              { color: '#e85113' }
            ]
          },{
            featureType: 'road.highway',
            elementType: 'geometry.stroke',
            stylers: [
              { color: '#efe9e4' },
              { lightness: -40 }
            ]
          },{
            featureType: 'transit.station',
            stylers: [
              { weight: 9 },
              { hue: '#e85113' }
            ]
          },{
            featureType: 'road.highway',
            elementType: 'labels.icon',
            stylers: [
              { visibility: 'off' }
            ]
          },{
            featureType: 'water',
            elementType: 'labels.text.stroke',
            stylers: [
              { lightness: 100 }
            ]
          },{
            featureType: 'water',
            elementType: 'labels.text.fill',
            stylers: [
              { lightness: -100 }
            ]
          },{
            featureType: 'poi',
            elementType: 'geometry',
            stylers: [
              { visibility: 'on' },
              { color: '#f0e4d3' }
            ]
          },{
            featureType: 'road.highway',
            elementType: 'geometry.fill',
            stylers: [
              { color: '#efe9e4' },
              { lightness: -25 }
            ]
          }
        ];

        function initMap() {
            // Constructor creates a new map - only center and zoom are required.
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 40.7413549, lng: -73.9980244 },
                zoom: 12,
                styles: styles,
                mapTypeControl: false
            });

            largeInfowindow = new google.maps.InfoWindow();
            bounds = new google.maps.LatLngBounds();

            function makeMarkerIcon(markerColor) {
                var markerImage = new google.maps.MarkerImage(
                    'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+ markerColor +
                    '|40|_|%E2%80%A2',
                    new google.maps.Size(21, 34),
                    new google.maps.Point(0, 0),
                    new google.maps.Point(10, 34),
                    new google.maps.Size(21,34));
                return markerImage;
            }
            highlightedIcon = makeMarkerIcon('FFFF24');
            defaultIcon = makeMarkerIcon('0091ff');
        }    

        var locationPoint = function(data){
            this.title = ko.observable(data.title);
            this.location = ko.observable(data.location);
            }


        var ViewModel = function(){
            var self = this;
            
            self.searchQuery = ko.observable();
            this.locationList = ko.observableArray([]);
            
            self.addFilter = function(){
                self.hideListings();
                self.locationList.removeAll();
                
                locations.forEach(function(location){
                    
                    if (location.title.toLowerCase().indexOf(self.searchQuery()) >= 0 || self.searchQuery() == '') {
                        var markerLocation = location.location;
                        var markerTitle = location.title;
                        var marker = new google.maps.Marker({
                            position: markerLocation,
                            title: markerTitle,
                            animation: google.maps.Animation.DROP,
                            map: map
                        })
                        self.locationList.push( marker );   
                        marker.setIcon(defaultIcon);

                        marker.addListener('click', function() {
                            self.populateInfoWindow(this, largeInfowindow);
                        });

                        marker.addListener('mouseover', function() {
                            this.setIcon(highlightedIcon);
                        });
                        marker.addListener('mouseout', function() {
                            this.setIcon(defaultIcon);
                        });
                    }
                })
            }
            
            self.populateInfoWindow = function(marker, infowindow) {
                // Check to make sure the infowindow is not already opened on this marker.
                if (infowindow.marker != marker) {
                    infowindow.marker = marker;
                    var positionLocation;
                    positionLocation = marker.position;
                    var locationLat = positionLocation.lat();
                    var locationLng = positionLocation.lng();
                    
                    var locationInfo;
                    locationInfo = this.getLocationInfo(locationLat, locationLng);
                    
                    if (locationInfo != false) {
                        
                        var street = locationInfo['results'][0]['locations'][0]['street'];
                        alert(street);
                        infowindow.setContent('<div><strong>' + marker.title + '</strong></div><br><div>' + marker.position + '</div>');
                    } else {
                        alert(false);
                        infowindow.setContent('<div><strong>' + marker.title + '</strong></div><br><div>' + marker.position + '</div>');
                    }

                    
                    infowindow.open(map, marker);
                    // Make sure the marker property is cleared if the infowindow is closed.
                    infowindow.addListener('closeclick', function() {
                    infowindow.marker = null;
            });
            }
        }
            // This function will loop through the markers array and display them all.
            self.showListings = function() {
                
                var bounds = new google.maps.LatLngBounds();
                // Extend the boundaries of the map for each marker and display the marker
                for (var i = 0; i < self.locationList().length; i++) {
                    self.locationList()[i].setMap(map);
                    bounds.extend(self.locationList()[i].position);
                }
                map.fitBounds(bounds);
            }

            self.hideListings = function(){
                var bounds = new google.maps.LatLngBounds();
                // Extend the boundaries of the map for each marker and display the marker
                for (var i = 0; i < self.locationList().length; i++) {
                    self.locationList()[i].setMap(null);
                }
                
            }

            bounceMarker = function(marker){
                self.resetAnimation();
                marker.setAnimation(google.maps.Animation.BOUNCE);
                self.populateInfoWindow(this, largeInfowindow);
                
            }

            self.resetAnimation = function(){
                // to reset all markers animation
                for (var i = 0; i < self.locationList().length; i++) {
                    self.locationList()[i].setAnimation(null);
                }
            }

            self.getLocationInfo = function(lat, lng){
                var url = 'http://www.mapquestapi.com/geocoding/v1/reverse?key=uMQJPEA0UdVi6SAAHas6CtCkLvNUfQrI&location='
                    + lat + ',' + lng +'&includeRoadMetadata=true&includeNearestIntersection=true';
                $.ajax({
                    type: 'GET',
                    url: url,
                    dataType: 'json',
                    success: function(json) {
                        console.log(JSON.stringify(json));
                        return (JSON.stringify(json));
                    },
                    error: function(error){
                        console.log(error)
                        return false;
                    }

                });


            }

        }


        ko.applyBindings(new ViewModel());
    
    


    </script>

    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDceNPNLj_wgYlXJhzG8xb0-8EeplLByWk&v=3&callback=initMap">
    </script>
    
</body>

</html>